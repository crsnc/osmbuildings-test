<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir â€“ Indoor & Outdoor Harita</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <link href="https://cdn.osmbuildings.org/4.1.1/OSMBuildings.css" rel="stylesheet">
  <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings.js"></script>

  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#ffffff }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f3f4f6}
    #map{position:fixed; inset:0}

    /* Attribution kÃ¼Ã§Ã¼k ve sade (lisansa uygun) */
    .ol-attribution{font-size:10px; opacity:.85}
    .ol-attribution button{display:none}

    /* Alt panel (tek yerde tÃ¼m kontroller) */
    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
           width:min(780px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px}
    .stack{display:flex; flex-direction:column; gap:8px}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button,.btn{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .pill input{accent-color:#1d4ed8}
    .muted{color:var(--muted)}

    /* Arama sonuÃ§larÄ± */
    .results{background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:36vh; overflow:auto; display:none}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}
    .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}

    /* YÃ¶nerge kutusu */
    .dir{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:10px}
    .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb}
    .dir .sum{font-weight:600}
    .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
    .step{display:flex; gap:8px; padding:6px 0; border-bottom:1px dashed #e5e7eb}
    .step:last-child{border-bottom:none}

    /* Popup */
    .ol-popup{position:absolute; background:#fff; padding:10px; border-radius:10px; border:1px solid #e5e7eb; min-width:220px; box-shadow:var(--shadow); transform:translate(-50%,-100%); }
    .ol-popup-closer{position:absolute; right:8px; top:6px; text-decoration:none; color:#9ca3af}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}

    /* Konum doÄŸruluk rozeti: SAÄž ALTA */
    .acc{position:fixed; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}

    /* 3D KontrolÃ¼ */
    .toggle-3d {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 1000;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .toggle-3d.active {
      background: #e0e7ff;
      border-color: #c7d2fe;
    }

    @media (max-width:520px){ .panel{bottom:8px} }
  </style>
</head>
<body>

  <!-- 3D KontrolÃ¼ -->
  <div id="toggle3d" class="toggle-3d">
    <span>3D: KapalÄ±</span>
  </div>

  <!-- Tek panel -->
  <div class="panel">
    <div class="card p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuzâ€¦" />
        <button id="go" disabled>Git</button>
        <select id="lang" aria-label="Language">
          <option value="tr" selected>TR</option>
          <option value="en">EN</option>
          <option value="ru">RU</option>
          <option value="de">DE</option>
          <option value="pl">PL</option>
        </select>
      </div>
      <div class="row" style="flex-wrap:wrap">
        <button id="pick">Haritadan Hedef</button>
        <button id="follow">ðŸŽ¯ Ä°zle: KapalÄ±</button>
        <button id="toggleDetails">Detaylar: KapalÄ±</button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
        <button id="reset">SÄ±fÄ±rla</button>
        <span class="muted" id="hint" style="display:none">ðŸ”Ž Arama aÃ§Ä±k</span>
      </div>
      <div id="results" class="results"></div>
      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">â€“</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">â–²</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>
      <div class="muted" style="font-size:11px; text-align:right">Â© aihotelstech Â· Â© OpenStreetMap contributors</div>
    </div>
  </div>

  <!-- Konum doÄŸruluk rozeti -->
  <div id="acc" class="acc" style="display:none"></div>

  <!-- Popup -->
  <div id="popup" class="ol-popup" style="display:none">
    <a href="#" id="popup-closer" class="ol-popup-closer">âœ•</a>
    <div id="popup-content"></div>
  </div>

  <div id="map" aria-label="Harita"></div>

<script>
// ========= OpenLayers Base =========
const base = new ol.layer.Tile({
  source: new ol.source.OSM({
    attributions: 'Â© aihotelstech Â· Â© OpenStreetMap contributors'
  })
});

const indoorSource  = new ol.source.Vector();
const outdoorSource = new ol.source.Vector();

const indoorLayer  = new ol.layer.VectorImage({ source: indoorSource });
const outdoorLayer = new ol.layer.VectorImage({ source: outdoorSource });

const map = new ol.Map({
  target:'map',
  layers:[base, indoorLayer, outdoorLayer],
  view:new ol.View({
    center: ol.proj.fromLonLat([31.8046,36.6002]),
    zoom:16,
    rotation:0
  })
});

map.addControl(new ol.control.Attribution({collapsible:false}));
map.addControl(new ol.control.Rotate());

// ========= OSMBuildings =========
let osmb = null;
let is3dMode = false;

// 3D modunu deÄŸiÅŸtirme fonksiyonu
function toggle3dMode() {
  is3dMode = !is3dMode;
  
  const toggleButton = document.getElementById('toggle3d');
  
  if (is3dMode) {
    // 3D modu aÃ§
    if (!osmb) {
      osmb = new OSMBuildings({ 
        baseURL: 'https://cdn.osmbuildings.org/4.1.1/',
        minZoom: 15,
        position: { 
          latitude: 36.6002, 
          longitude: 31.8046 
        }
      });
      
      osmb.addMapTiles('https://tile.openstreetmap.org/{z}/{x}/{y}.png');
      osmb.addGeoJSONTiles('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');
      
      // Harita div'ine ekle
      const mapDiv = document.getElementById('map');
      osmb.appendTo(mapDiv);
      
      // OL â†’ OSMBuildings senkronizasyonu
      const view = map.getView();
      
      function syncOSMB() {
        if (!osmb) return;
        
        const center = ol.proj.toLonLat(view.getCenter());
        osmb.setPosition({ 
          latitude: center[1], 
          longitude: center[0] 
        });
        osmb.setZoom(view.getZoom());
        osmb.setRotation(view.getRotation());
      }
      
      // Ä°lk senkronizasyon
      syncOSMB();
      
      // View deÄŸiÅŸince gÃ¼ncelle
      view.on('change:center', syncOSMB);
      view.on('change:zoom', syncOSMB);
      view.on('change:rotation', syncOSMB);
    } else {
      osmb.show();
    }
    
    toggleButton.classList.add('active');
    toggleButton.innerHTML = '<span>3D: AÃ§Ä±k</span>';
  } else {
    // 3D modu kapat
    if (osmb) {
      osmb.hide();
    }
    
    toggleButton.classList.remove('active');
    toggleButton.innerHTML = '<span>3D: KapalÄ±</span>';
  }
}

// 3D dÃ¼ÄŸmesine tÄ±klama olayÄ±nÄ± ekle
document.getElementById('toggle3d').addEventListener('click', toggle3dMode);

// Harita yÃ¼klendikten sonra OSMBuildings'i baÅŸlat
map.once('postrender', function() {
  // Ä°lk baÅŸta 3D mod kapalÄ±, sadece hazÄ±rlÄ±k yap
  osmb = new OSMBuildings({ 
    baseURL: 'https://cdn.osmbuildings.org/4.1.1/',
    minZoom: 15,
    position: { 
      latitude: 36.6002, 
      longitude: 31.8046 
    }
  });
  
  osmb.addMapTiles('https://tile.openstreetmap.org/{z}/{x}/{y}.png');
  osmb.addGeoJSONTiles('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');
  
  // Harita div'ine ekle ve hemen gizle
  const mapDiv = document.getElementById('map');
  osmb.appendTo(mapDiv);
  osmb.hide();
  
  // OL â†’ OSMBuildings senkronizasyonu
  const view = map.getView();
  
  function syncOSMB() {
    if (!osmb) return;
    
    const center = ol.proj.toLonLat(view.getCenter());
    osmb.setPosition({ 
      latitude: center[1], 
      longitude: center[0] 
    });
    osmb.setZoom(view.getZoom());
    osmb.setRotation(view.getRotation());
  }
  
  // Ä°lk senkronizasyon
  syncOSMB();
  
  // View deÄŸiÅŸince gÃ¼ncelle
  view.on('change:center', syncOSMB);
  view.on('change:zoom', syncOSMB);
  view.on('change:rotation', syncOSMB);
});
</script>
</body>
</html>
