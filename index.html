<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Otel 3D Harita</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.osmbuildings.org/4.0.0/OSMBuildings.js"></script>

<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
  .search-panel { position: absolute; top:10px; left:50%; transform: translateX(-50%); z-index:1000;
                  background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
  .search-panel input { padding:6px 8px; width:200px; border:1px solid #ccc; border-radius:4px; }
  .search-panel button { padding:6px 8px; margin-left:4px; }
</style>
</head>
<body>

<div id="map"></div>

<div class="search-panel">
  <input type="search" id="searchBox" placeholder="Ara: restoran, spa, havuz…">
  <button id="searchBtn">Git</button>
</div>

<script>
  // Başlangıç konumu: Resepsiyon (örnek koordinatlar)
  const receptionLat = 36.6002;
  const receptionLon = 31.8046;

  // Leaflet harita
  const map = L.map('map').setView([receptionLat, receptionLon], 17);

  // OpenStreetMap katmanı
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // OSMBuildings (3D her zaman açık)
  const osmb = new OSMBuildings({
      baseURL: 'https://cdn.osmbuildings.org/4.0.0/OSMBuildings',
      container: 'map',
      position: { latitude: receptionLat, longitude: receptionLon },
      zoom: 17,
      minZoom: 15,
      maxZoom: 22
  });
  osmb.addMapTiles('https://{a,b,c}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
  });

  // Marker ve Feature yönetimi
  let indoorFeatures = [];
  let outdoorFeatures = [];
  let markersLayer = L.layerGroup().addTo(map);
  let destinationMarker = null;

  // Indoor & Outdoor JSON yükle
  async function loadFeatures() {
    try {
      const indoor = await fetch('indoor.json').then(r=>r.json());
      const outdoor = await fetch('outdoor.json').then(r=>r.json());

      indoorFeatures = L.geoJSON(indoor, {
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, { radius:7, color:'blue', fillColor:'blue', fillOpacity:0.7 });
        }
      }).addTo(markersLayer);

      outdoorFeatures = L.geoJSON(outdoor, {
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, { radius:7, color:'green', fillColor:'green', fillOpacity:0.7 });
        }
      }).addTo(markersLayer);

    } catch(err) {
      console.error("JSON yüklenemedi:", err);
    }
  }

  loadFeatures();

  // Arama
  const searchBox = document.getElementById('searchBox');
  const searchBtn = document.getElementById('searchBtn');

  function normalize(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,''); }

  function searchFeature(term){
    term = normalize(term);
    let allFeatures = [];
    indoorFeatures.eachLayer(f => allFeatures.push(f));
    outdoorFeatures.eachLayer(f => allFeatures.push(f));

    for (let f of allFeatures){
      let props = f.feature.properties || {};
      let names = [props.name, props.name_tr, props.name_en].filter(Boolean).map(normalize);
      if(names.some(n=>n.includes(term))){
        map.setView(f.getLatLng(), 18);
        if(destinationMarker) markersLayer.removeLayer(destinationMarker);
        destinationMarker = L.marker(f.getLatLng(), {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize:[32,32]})}).addTo(markersLayer);
        break;
      }
    }
  }

  searchBtn.addEventListener('click', ()=>searchFeature(searchBox.value));
  searchBox.addEventListener('keypress', e=>{ if(e.key==='Enter') searchFeature(searchBox.value); });

  // Haritadan hedef seçimi
  map.on('click', e=>{
    if(destinationMarker) markersLayer.removeLayer(destinationMarker);
    destinationMarker = L.marker(e.latlng, {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize:[32,32]})}).addTo(markersLayer);
  });

</script>
</body>
</html>
